{% extends "base.html" %}
{% block title %}Cat√°logo de Productos - RopaStore{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Hero Section -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="card border-0 bg-gradient-primary text-white rounded-4 overflow-hidden">
        <div class="card-body p-5 text-center">
          <h1 class="display-5 fw-bold mb-3">üéÅ Descubre Nuestro Cat√°logo</h1>
          <p class="lead mb-4 opacity-75">Encuentra las mejores prendas y accesorios con estilo √∫nico</p>
          
          <!-- Filtros Mejorados -->
          <form method="GET" action="{{ url_for('usuario_cp.user_dashboard') }}" class="row g-3 justify-content-center">
            <div class="col-lg-4 col-md-5">
              <div class="input-group input-group-lg">
                <span class="input-group-text bg-white bg-opacity-20 text-white border-0">
                  <i class="bi bi-search"></i>
                </span>
                <input type="text" name="buscar" class="form-control border-0 bg-white bg-opacity-10 text-white" 
                       placeholder="Buscar productos..." value="{{ request.args.get('buscar', '') }}"
                       style="backdrop-filter: blur(10px);">
              </div>
            </div>
            <div class="col-lg-3 col-md-4">
              <select name="categoria" class="form-select form-select-lg border-0 bg-white bg-opacity-10 text-white"
                      style="backdrop-filter: blur(10px);">
                <option value="">Todas las categor√≠as</option>
                {% for c in categorias %}
                  <option value="{{ c.id }}" {% if request.args.get('categoria') == c.id|string %}selected{% endif %}>
                    {{ c.nombre }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-lg-2 col-md-3">
              <button type="submit" class="btn btn-warning btn-lg w-100 rounded-3 fw-semibold">
                <i class="bi bi-funnel me-2"></i>Filtrar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Estad√≠sticas R√°pidas -->
  <div class="row g-3 mb-5">
    <div class="col-xl-3 col-md-6">
      <div class="card border-0 bg-light rounded-4 shadow-sm h-100">
        <div class="card-body text-center p-4">
          <div class="bg-primary bg-opacity-10 rounded-3 p-3 d-inline-flex mb-3">
            <i class="bi bi-box-seam text-primary display-6"></i>
          </div>
          <h3 class="fw-bold text-dark mb-1">{{ productos|length }}</h3>
          <p class="text-muted mb-0">Productos Disponibles</p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card border-0 bg-light rounded-4 shadow-sm h-100">
        <div class="card-body text-center p-4">
          <div class="bg-success bg-opacity-10 rounded-3 p-3 d-inline-flex mb-3">
            <i class="bi bi-tags text-success display-6"></i>
          </div>
          <h3 class="fw-bold text-dark mb-1">{{ categorias|length }}</h3>
          <p class="text-muted mb-0">Categor√≠as</p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card border-0 bg-light rounded-4 shadow-sm h-100">
        <div class="card-body text-center p-4">
          <div class="bg-warning bg-opacity-10 rounded-3 p-3 d-inline-flex mb-3">
            <i class="bi bi-star text-warning display-6"></i>
          </div>
          <h3 class="fw-bold text-dark mb-1">{{ productos|selectattr('destacado')|list|length }}</h3>
          <p class="text-muted mb-0">Productos Destacados</p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card border-0 bg-light rounded-4 shadow-sm h-100">
        <div class="card-body text-center p-4">
          <div class="bg-info bg-opacity-10 rounded-3 p-3 d-inline-flex mb-3">
            <i class="bi bi-cart3 text-info display-6"></i>
          </div>
          <h3 class="fw-bold text-dark mb-1">{{ session.get('carrito', {})|length }}</h3>
          <p class="text-muted mb-0">En tu Carrito</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Grid de Productos Mejorado -->
  <div class="row g-4">
    {% for p in productos %}
    <div class="col-xl-3 col-lg-4 col-md-6">
      <div class="card product-card border-0 shadow-sm h-100 rounded-4 overflow-hidden">
        <div class="position-relative">
          {% if p.imagen %}
            <img src="{{ url_for('usuario_cp.serve_uploaded_file', filename=p.imagen) }}"
                 class="card-img-top" 
                 alt="{{ p.nombre }}"
                 style="height: 250px; object-fit: cover;">
          {% else %}
            <div class="bg-light d-flex align-items-center justify-content-center" 
                 style="height: 250px;">
              <i class="bi bi-image text-muted display-4"></i>
            </div>
          {% endif %}
          
          <!-- Badges -->
          <div class="position-absolute top-0 start-0 m-3">
            {% if p.destacado %}
            <span class="badge bg-warning bg-opacity-90 text-dark rounded-pill px-3 py-2">
              <i class="bi bi-star-fill me-1"></i>Destacado
            </span>
            {% endif %}
          </div>
          <div class="position-absolute top-0 end-0 m-3">
            {% if p.stock < 3 and p.stock > 0 %}
            <span class="badge bg-danger bg-opacity-90 text-white rounded-pill px-3 py-2">
              <i class="bi bi-exclamation-triangle me-1"></i>√öltimas {{ p.stock }}
            </span>
            {% elif p.stock == 0 %}
            <span class="badge bg-secondary bg-opacity-90 text-white rounded-pill px-3 py-2">
              <i class="bi bi-x-circle me-1"></i>Agotado
            </span>
            {% endif %}
          </div>
        </div>

        <div class="card-body d-flex flex-column p-4">
          <div class="flex-grow-1">
            <h5 class="card-title fw-bold text-dark mb-2">{{ p.nombre }}</h5>
            <p class="text-muted small mb-3">
              <i class="bi bi-tag me-1"></i>{{ p.categoria.nombre if p.categoria else 'General' }}
            </p>
            <p class="text-muted small mb-3 line-clamp-2">
              {{ p.descripcion[:100] }}{% if p.descripcion|length > 100 %}...{% endif %}
            </p>
          </div>

          <div class="d-flex justify-content-between align-items-center mt-auto">
            <div>
              <span class="h4 fw-bold text-success mb-0">${{ "%.2f"|format(p.precio) }}</span>
              <div class="text-muted small">
                <i class="bi bi-box-seam me-1"></i>{{ p.stock }} disponibles
              </div>
            </div>
            
            {% if p.stock > 0 %}
            <form action="{{ url_for('usuario_cp.agregar_carrito', producto_id=p.id) }}" method="POST" class="d-inline">
              <button type="submit" class="btn btn-primary rounded-3 px-4 py-2" 
                      data-bs-toggle="tooltip" title="Agregar al carrito">
                <i class="bi bi-cart-plus me-2"></i>Agregar
              </button>
            </form>
            {% else %}
            <button class="btn btn-outline-secondary rounded-3 px-4 py-2" disabled>
              <i class="bi bi-x-circle me-2"></i>Agotado
            </button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <div class="col-12">
      <div class="card border-0 bg-light rounded-4 text-center py-5">
        <div class="card-body">
          <i class="bi bi-search display-1 text-muted mb-3"></i>
          <h3 class="fw-bold text-dark mb-3">No se encontraron productos</h3>
          <p class="text-muted mb-4">Intenta con otros t√©rminos de b√∫squeda o categor√≠as diferentes.</p>
          <a href="{{ url_for('usuario_cp.user_dashboard') }}" class="btn btn-primary rounded-3 px-4 py-2">
            <i class="bi bi-arrow-clockwise me-2"></i>Ver Todos los Productos
          </a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Paginaci√≥n (si es necesaria en el futuro) -->
  {% if productos|length == 0 %}
  <div class="row mt-5">
    <div class="col-12 text-center">
      <div class="card border-0 bg-warning bg-opacity-5 rounded-4">
        <div class="card-body py-5">
          <i class="bi bi-emoji-frown display-1 text-warning mb-3"></i>
          <h4 class="fw-bold text-dark mb-3">¬°Lo sentimos!</h4>
          <p class="text-muted mb-0">No hay productos disponibles en este momento. Vuelve pronto para descubrir nuevas incorporaciones.</p>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Tooltips
  const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
  tooltips.forEach(t => new bootstrap.Tooltip(t));

  // Efectos de hover en las tarjetas de producto
  const productCards = document.querySelectorAll('.product-card');
  productCards.forEach(card => {
    card.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-8px)';
      this.style.boxShadow = '0 12px 30px rgba(0,0,0,0.15)';
    });
    
    card.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
      this.style.boxShadow = '';
    });
  });

  // Animaci√≥n para los badges de stock bajo
  const lowStockBadges = document.querySelectorAll('.badge.bg-danger');
  lowStockBadges.forEach(badge => {
    badge.style.animation = 'pulse 2s infinite';
  });
});
</script>

<style>
  .bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .product-card {
    transition: all 0.3s ease;
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    transition: all 0.3s ease;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
  }

  .bg-opacity-10 {
    background-opacity: 0.1 !important;
  }

  .bg-opacity-90 {
    background-opacity: 0.9 !important;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  /* Placeholder personalizado para inputs */
  .form-control::placeholder {
    color: rgba(255, 255, 255, 0.7) !important;
  }

  .form-select option {
    color: #000;
  }

  /* Mejora la legibilidad del texto en fondos con blur */
  .bg-white.bg-opacity-10 {
    backdrop-filter: blur(10px);
  }
</style>
{% endblock %}